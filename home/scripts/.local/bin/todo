#!/usr/bin/env bash -e

export SHELL=$(which fish)

fzf="fzf"

if ! command -v $EDITOR &> /dev/null; then
  >&2 echo "todo: $EDITOR editor set by \$EDITOR env variable could not be found"
  exit
fi

todo=${TODO_DIR:-"$HOME/.todo"}
[ ! -d "$todo" ] && mkdir -p "$todo/archive"

case "$1" in
  ar*)
    target=$2
    if [ -z "$target" ]; then
      >&2 echo "todo: usage: todo archive <task-id>"
    else
      mv -i $todo/$target* $todo/archive
    fi
    ;;

  l*)
    expression="find $todo -type f -maxdepth 1"
    shift
    for phrase in "$@"; do
      case "${phrase:0:1}" in
      "-")
        expression="$expression -not -exec grep --quiet '+${phrase:1}' {} \;"
        ;;
      *)
        expression="$expression -exec grep --quiet '$phrase' {} \;"
        ;;
      esac
    done
    expression="$expression -print"
    for file in $(eval $expression); do
      summary=$(head -1 $file)
      echo "$file" | sed "s/^.*\/\(.*\)/\1 : $summary/"
    done
    ;;

  a*)
    id=$(date +%s | sha1sum - | cut -d ' ' -f 1)
    shift
    summary=$*
    if [ -z "$summary" ]; then
      $EDITOR $todo/$id
    else
      echo "$summary" > $todo/$id
    fi
    if [ -s $todo/$id ]; then
      echo $id
    else
      >&2 echo "todo: nothing to add"
    fi
    ;;

  r*)
    target=$2
    if [ -z "$target" ]; then
      >&2 echo "todo: usage: todo remove <task-id>"
    else
      rm -i $todo/$target
    fi
    ;;

  e*)
    target=$2
    if [ -z "$target" ]; then
      >&2 echo "todo: usage: todo edit <task-id>"
    else
      $EDITOR $todo/$target*
    fi
    ;;

  s*)
    target=$2
    if [ -z "$target" ]; then
      >&2 echo "todo: usage: todo show <task-id>"
    else
      cat $todo/$target*
    fi
    ;;

  t*)
    target=$2
    tag=$3
    if [ -z "$target" ] || [ -z "$tag" ]; then
      >&2 echo "todo: usage: todo tag <task-id> <tag>"
    else
      echo "$tag" >> $todo/$target*
    fi
    ;;

  *)
    >&2 echo "usage: todo [list|add|edit|show|remove|archive|tag|help]"
    ;;
esac
