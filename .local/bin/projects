#!/bin/bash

projects=${PROJECTS_DIR:-"$HOME/Projects"}
list=`tmux ls 2> /dev/null | cut -f1 -d':' | sort`

case "$1" in
  "ls")
    echo $list
    ;;
  "add")
    target=`ls -1 $projects | sort -n | fzf --prompt "Projects> "`
    tmux new-session -d -s $target -c $projects/$target $EDITOR
    ;;
  "new")
    target=$2
    if [ -z "$target" ]; then
      >&2 echo "usage: projects new <project-name>"
    else
      if [ -d $projects/$target ]; then
        >&2 echo "project already exists"
      else
        mkdir -p $projects/$2
        pushd $projects/$target
          git init
        popd
        tmux new-session -s $target -c $projects/$target $EDITOR
      fi
    fi
    ;;
  "clone")
    uri=$2
    target=$(basename "$uri" .git)
    if [ -z "$target" ]; then
      >&2 echo "usage: projects clone <project-git-uri>"
    else
      if [ -d $projects/$target ]; then
        >&2 echo "project already exists"
      else
        pushd $projects
          git clone $uri
        popd
        tmux new-session -s $target -c $projects/$target $EDITOR
      fi
    fi
    ;;
  *)
    if [ -n "$TMUX" ]; then
      >&2 echo "usage: projects [add|new|clone|ls|help]"
    else
      tmux attach
    fi
    ;;
esac
