#!/bin/bash

projects=${PROJECTS_DIR:-"$HOME/Projects"}
list=$(tmux ls 2> /dev/null | cut -f1 -d':' | sort)

pushd () {
  command pushd "$@" > /dev/null
}
popd () {
  command popd "$@" > /dev/null
}

case "$1" in
  "ls")
    if [ -z "$list" ]; then
      >&2 echo "projects: no projects available"
    else
      echo "$list"
    fi
    ;;

  "add")
    if [ -z "$(ls -1 "$projects" | sort -n)" ]; then
      >&2 echo "projects: no projects available under $projects"
    else
      target=$(ls -1 "$projects" | sort -n | fzf --prompt "Projects> ")
      tmux new-session -d -s "$target" -c "$projects/$target" "$EDITOR"
    fi
    ;;

  "new")
    target=$2
    if [ -z "$target" ]; then
      >&2 echo "projects: usage: projects new <project-name>"
    else
      if [ -d "$projects/$target" ]; then
        >&2 echo "projects: $target already exists"
      else
        mkdir -p "$projects"/"$2"
        pushd "$projects/$target" || exit
          git init
        popd
        tmux new-session -d -s "$target" -c "$projects/$target" "$EDITOR"
      fi
    fi
    ;;

  "clone")
    uri=$2
    target=$(basename "$uri" .git)
    if [ -z "$target" ]; then
      >&2 echo "projects: usage: projects clone <project-git-uri>"
    else
      if [ -d "$projects/$target" ]; then
        >&2 echo "projects: $target already exists"
      else
        pushd "$projects"
          git clone "$uri"
        popd
        tmux new-session -d -s "$target" -c "$projects/$target" "$EDITOR"
      fi
    fi
    ;;

  "sync")
    if [ -z "$list" ]; then
      >&2 echo "projects: nothing to sync"
    else
      for name in $list; do
        project="$projects/$name"
        if [ -d "$project" ]; then
          echo "projects: $project"
          pushd "$project"
            git fetch --all && echo "projects:   fetched"
            for remote in $(git remote); do
              for branch in $(git branch); do
                label=$(git config "branch.$branch.note" | xargs)
                if [ ! -z "$label" ]; then
                  git push "$remote" "$branch":"$branch" >/dev/null 2>&1 && echo "projects:   pushed $branch on $remote"
                fi
              done
            done
          popd
        else
          >&2 echo "projects: could not cd to $project"
        fi
      done
    fi
    ;;

  *)
    if [ -n "$TMUX" ]; then
      >&2 echo "usage: projects [add|new|clone|ls|sync|help]"
    else
      tmux attach
    fi
    ;;
esac
